<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
        <title>CTFd for OWASP Juice Shop</title>
        <meta name="description" content="Generate INSERT statements for CTFd with the OWASP Juice Shop challenges">
        <meta name="version" content="0.1.0">
    </head>
    <body>
        <div class="container-fluid">

            <h2 class="page-header page-header-sm">
                Produce <code>INSERT</code> statements for the <a href='https://ctfd.io' target="_blank">CTFd</a>
                system for use with <a href='https://www.owasp.org/index.php/OWASP_Juice_Shop_Project' target="_blank">OWASP Juice Shop</a>
            </h2>

            <div class="container-fluid well">
                <legend>Step 1 of 5: <small>Enter the URL of a version of Juice Shop with the set of challenges that you want to use for the CTF. The default is the latest official release hosted on Heroku.</small></legend>
                <div class="row">
                    <div class="form-group">
                        <label for="ChallengeURL">URL</label>
                        <input type="text" class="form-control input-sm" id="ChallengeURL" name="ChallengeURL" value="https://juice-shop.herokuapp.com"/>
                    </div>
                </div>
            </div>

            <div class="container-fluid well">
                <legend>Step 2 of 5: <small>Enter <em>either</em> a secret key to use for generating the flag <em>or</em> an URL to the <code>ctf.key</code> file. The default is the latest official release from the GitHub repository <code>master</code> branch.</small></legend>
                <div class="row">
                    <div class="form-group">
                        <label for="SecretKey">Key</label>
                        <input type="text" class="form-control input-sm" id="SecretKey" name="SecretKey" value=""/>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group">
                        <label for="KeyURL">URL</label>
                        <input type="text" class="form-control input-sm" id="KeyURL" name="KeyURL" value="https://raw.githubusercontent.com/bkimminich/juice-shop/master/ctf.key"/>
                    </div>
                </div>
            </div>

            <div class="container-fluid well">
                <legend>Step 3 of 5: <small>Use the checkboxes below to decide whether you want to add:</small></legend>
                <div class="row">
                    <div class="form-group">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" id="chkDELETE" name="chkDELETE" checked/> A <code>DELETE</code> statement before the <code>INSERT</code> statements to clear the Challenges table.
                            </label>
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" id="chkSELECT" name="chkSELECT" checked/> A <code>SELECT</code> statement after the <code>INSERT</code> statements to show the contents of the Challenges table at the end.
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container-fluid well">
                <legend>Step 4 of 5: <small>Press the button below to generate the <code>INSERT</code> statements and use these to setup the database. (Further guidance in step 5)</small></legend>
                <div class="row">
                    <div class="form-group">
                        <input type=button class="btn btn-success" onclick="GenerateInserts();" value="Generate INSERT statements"/>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group">
                        <label for="result">Output</label>
                        <textarea class="form-control input-sm" cols="160" rows="20" id="result" value="" readonly></textarea>
                    </div>
                </div>
            </div>

            <div class="container-fluid well">
                <legend>Step 5 of 5: <small>If you don't already have a CTFd installation, the easiest way to set one up and configure it for Juice Shop is as follows:</small></legend>
                <div class="row">
                    <ol type="a">
                        <li>
                            Setup <a href='https://docs.docker.com/compose/install/'>Docker host and Docker compose</a>.
                        </li>
                        <li>
                            Follow steps 2-4 from <a href='https://github.com/isislab/CTFd/wiki/Deployment#docker'>the CTFd Docker setup</a>
                            to download the source code, create containers and start them.
                        </li>
                        <li>
                            After running <code>docker-compose up</code> from previous step, you should be able to
                            browse to your CTFd instance UI (<code>&lt;&lt;docker host IP&gt;&gt;:8000</code>
                            by default) and create an admin user and CTF name.
                        </li>
                        <li>
                            Once you have done this, run <code>docker-compose down</code>
                            or use <code>Ctrl-C</code>
                            to shut down CTFd. Note: Unlike a usual Docker container, data will persist even afterwards.

                        </li>
                        <li>
                            Add the following section to the <code>docker-compose.yml</code>
                            file and then run <code>docker-compose up</code>
                            again:<br><br>
<pre>ports:
  - "3306:3306"</pre>
                        </li>
                        <li>You can then use your favourite MySQL client to connect to the CTFd database (default
                            credentials are root with no password) and run the <code>INSERT</code> statement you created.
                        </li>
                        <li>When that is done, browse back to your CTFd instance UI and check everything has worked correctly.
                        </li>
                        <li>
                            If everything has worked, do another <code>docker-compose down</code>,
                            remove the ports section you added to <code>docker-compose.yml</code>
                            and then do <code>docker-compose up</code> again and you are ready to go!
                        </li>
                    </ol>
                </div>
            </div>

        </div>
    </body>

    <script type="text/javascript" src="https://cdn.rawgit.com/Caligatio/jsSHA/master/src/sha1.js"></script>
    <script>
        // Function to create the HMAC based on the code used in Juice Shop
        function toHmac(text, theSecretKey) {
            var shaObj = new jsSHA('SHA-1','TEXT')
            shaObj.setHMACKey(theSecretKey, 'TEXT')
            shaObj.update(text)
            return shaObj.getHMAC('HEX')
        }
        var myInit;
        function GenerateInsertsInner(SecretKey) {
            var InsertString = "";
            // Add a DELETE string at the start if selected by the user
            if (document.getElementById('chkDELETE').checked) {
                InsertString = InsertString + "DELETE FROM challenges;\n\r"
            }
            var ChallengeURL = document.getElementById("ChallengeURL").value + "/api/Challenges"
            fetch(ChallengeURL, myInit).then(function(response) {
                if (!response.ok) {
                    throw Error(response.statusText);
                }
                return response.json();
            }).then(function(j) {
                /* This is a default multiplier whereby the score will be = (difficulty x multiplier)
					   i.e. using these multipliers will create challenges with the following scores:
					   *     =  100
					   **    =  250
					   ***   =  450
					   ****  =  700
					   ***** = 1000 
					
					   I think it is fair to assume that completing a 5* task will be 10 times harder than a 1* task.
					
					*/
                var multiplier = [100, 125, 150, 175, 200];
                // For each challenge returned by the Challeges API, 
                for (var key in j.data) {
                    InsertString = InsertString + "insert into challenges (id, name, description, value, category, flags, hidden) values ("
                    InsertString = InsertString + "" + j.data[key].id + ", "
                    InsertString = InsertString + "\"" + j.data[key].name + "\", "
                    InsertString = InsertString + "\"" + j.data[key].description.replace(/\"/g, "\"\"") + " (Difficulty Level: " + j.data[key].difficulty + ")\", "
                    InsertString = InsertString + "\"" + j.data[key].difficulty * multiplier[j.data[key].difficulty - 1] + "\", "
                    InsertString = InsertString + "\"" + j.data[key].category + "\", "
                    InsertString = InsertString + "\"[{\"\"flag\"\": \"\"" + toHmac(j.data[key].name, SecretKey) + "\"\", \"\"type\"\": 0}]\", "
                    InsertString = InsertString + "0);\n\r"
                }
                if (document.getElementById('chkSELECT').checked) {
                    InsertString = InsertString + "SELECT * FROM challenges;\n\r"
                }
                document.getElementById("result").value = InsertString
            }).catch(function(error) {
                document.getElementById("result").value = "Error Fetching Challenges:\n\r" + error;
                console.log(error);
            });
        }
        // Function to create the insert statements
        function GenerateInserts() {
            document.getElementById("result").value = "Calculating...";
            myInit = {
                method: 'GET',
                mode: 'cors'
            };
            var KeyURL = document.getElementById("KeyURL").value
            var SecretKey = document.getElementById("SecretKey").value;
            // If no key was provided, this request reads the secret key from the URL provided (by default, the master JuiceShop github repository)
            if (SecretKey == "") {
                fetch(KeyURL, myInit).then(function(response) {
                    if (!response.ok) {
                        throw Error(response.statusText);
                    }
                    return response.text();
                }).then(function(t) {
                    SecretKey = t;
                    GenerateInsertsInner(SecretKey);
                }).catch(function(error) {
                    document.getElementById("result").value = "Error Fetching Key:\n\r" + error;
                    console.log(error);
                });
            } else {
                GenerateInsertsInner(SecretKey);
            }
            console.log("ok");
        }
    </script>
</html>
